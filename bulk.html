<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VecFleet Â· Alta Masiva de Choferes</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--p:#8D33FF;--c:#41EBD4;--bg:#070912;--s:#111827;--s2:#1C2535;--bd:rgba(141,51,255,.18);--t:#F1F5F9;--tm:#64748B;--g:#22C55E;--r:#EF4444;--y:#F59E0B;--o:#F97316;}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Inter','Segoe UI',sans-serif;background:var(--bg);background-image:radial-gradient(ellipse 80% 50% at 20% -10%,rgba(141,51,255,.1) 0%,transparent 60%),radial-gradient(ellipse 60% 40% at 80% 110%,rgba(65,235,212,.07) 0%,transparent 60%);color:var(--t);min-height:100vh;padding-bottom:100px}

/* HEADER */
header{background:rgba(11,14,26,.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--bd);padding:0 2rem;display:flex;align-items:center;justify-content:space-between;height:58px;position:sticky;top:0;z-index:100}
header img{height:30px}
.hright{display:flex;align-items:center;gap:1rem}
.hpill{background:linear-gradient(135deg,rgba(141,51,255,.15),rgba(65,235,212,.15));border:1px solid rgba(141,51,255,.3);color:var(--c);font-size:.68rem;font-weight:700;padding:.22rem .65rem;border-radius:100px;letter-spacing:.08em;text-transform:uppercase}
.hdot{width:7px;height:7px;background:var(--g);border-radius:50%;box-shadow:0 0 6px var(--g);animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.igear{background:none;border:none;color:var(--tm);cursor:pointer;font-size:1.1rem;padding:.3rem;opacity:.65;transition:opacity .2s}
.igear:hover{opacity:1;color:var(--t)}

/* MAIN */
main{max-width:1200px;margin:0 auto;padding:2rem 1.5rem}
.page-title{font-size:1.6rem;font-weight:800;margin-bottom:.35rem}
.page-title .gr{background:linear-gradient(90deg,var(--p),var(--c));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.page-sub{color:var(--tm);font-size:.88rem;margin-bottom:2rem}

/* UPLOAD ZONE */
.upload-zone{border:2px dashed rgba(141,51,255,.3);border-radius:20px;background:var(--s);padding:2.5rem;text-align:center;cursor:pointer;transition:all .25s;position:relative;margin-bottom:1.5rem}
.upload-zone:hover,.upload-zone.drag{border-color:var(--p);background:rgba(141,51,255,.05);box-shadow:0 0 0 1px var(--p),0 12px 40px rgba(141,51,255,.15)}
.upload-zone.locked{opacity:.45;cursor:not-allowed;pointer-events:none}
.upload-zone.locked input{pointer-events:none}
.upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.uz-icon{font-size:2.8rem;margin-bottom:.75rem}
.uz-title{font-size:1.05rem;font-weight:700;margin-bottom:.4rem}
.uz-sub{font-size:.82rem;color:var(--tm);margin-bottom:1.25rem}
.uz-types{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap}
.uz-tag{background:rgba(141,51,255,.12);border:1px solid rgba(141,51,255,.25);border-radius:8px;padding:.22rem .65rem;font-size:.72rem;font-weight:700;color:var(--p);text-transform:uppercase;letter-spacing:.06em}
.uz-tag.tox{background:rgba(65,235,212,.1);border-color:rgba(65,235,212,.25);color:var(--c)}
.uz-tag.ent{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.25);color:var(--g)}
.uz-tag.pdf{background:rgba(100,116,139,.1);border-color:rgba(100,116,139,.25);color:var(--tm)}

/* STATS BAR */
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:.75rem;margin-bottom:1.75rem}
.stat{background:var(--s);border:1px solid var(--bd);border-radius:14px;padding:.9rem 1rem;text-align:center}
.stat-num{font-size:1.6rem;font-weight:800;background:linear-gradient(135deg,var(--p),var(--c));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-num.green{background:var(--g);-webkit-background-clip:text}
.stat-num.red{background:var(--r);-webkit-background-clip:text}
.stat-num.yellow{background:var(--y);-webkit-background-clip:text}
.stat-lbl{font-size:.68rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--tm);margin-top:.2rem}

/* QUEUE INDICATOR */
#queue-bar{display:none;align-items:center;gap:.75rem;background:rgba(141,51,255,.08);border:1px solid rgba(141,51,255,.2);border-radius:12px;padding:.7rem 1rem;margin-bottom:1.25rem;font-size:.82rem;color:var(--p)}
#queue-bar.on{display:flex}
.qspin{width:14px;height:14px;border-radius:50%;border:2px solid rgba(141,51,255,.3);border-top-color:var(--p);animation:spin .8s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}

/* DRIVER GRID */
.grid-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
.grid-title{font-size:.72rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--tm)}
.grid-actions{display:flex;gap:.5rem}
.btn-sm{padding:.35rem .85rem;border-radius:8px;font-size:.78rem;font-weight:700;cursor:pointer;border:1px solid rgba(255,255,255,.1);background:transparent;color:var(--tm);transition:all .2s}
.btn-sm:hover{border-color:var(--p);color:var(--t)}
.btn-sm.active{background:rgba(141,51,255,.15);border-color:var(--p);color:var(--p)}
#driver-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:1rem}

/* DRIVER CARD */
.dcard{background:var(--s);border:1px solid var(--bd);border-radius:18px;overflow:hidden;opacity:0;transform:translateY(12px);transition:opacity .4s,transform .4s,border-color .2s,box-shadow .2s}
.dcard.show{opacity:1;transform:translateY(0)}
.dcard:hover{border-color:rgba(141,51,255,.3);box-shadow:0 8px 30px rgba(141,51,255,.1)}
.dcard.selected{border-color:var(--p);box-shadow:0 0 0 1px var(--p),0 8px 30px rgba(141,51,255,.2)}
.dcard-top{display:flex;align-items:center;gap:.85rem;padding:1.1rem;background:var(--s2);border-bottom:1px solid var(--bd)}
.dcard-check{width:18px;height:18px;border-radius:5px;border:2px solid rgba(255,255,255,.2);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
.dcard-check.on{background:var(--p);border-color:var(--p)}
.dcard-check.on::after{content:'âœ“';color:#fff;font-size:.7rem;font-weight:900}
.dcard-check.disabled{opacity:.3;cursor:default}
.davatar{width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,rgba(141,51,255,.3),rgba(65,235,212,.2));border:1px solid rgba(141,51,255,.2);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:800;color:var(--p)}
.davatar img{width:100%;height:100%;object-fit:cover}
.dinfo{flex:1;min-width:0}
.dname{font-size:.88rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.dcpf{font-size:.72rem;color:var(--tm);font-family:monospace;margin-top:.15rem}
.dcard-docs{padding:.9rem 1rem}
.ddoc{display:flex;align-items:center;gap:.6rem;padding:.45rem 0;border-bottom:1px solid rgba(255,255,255,.04)}
.ddoc:last-child{border-bottom:none}
.ddoc-icon{font-size:.95rem;width:22px;text-align:center;flex-shrink:0}
.ddoc-name{font-size:.75rem;font-weight:600;color:var(--tm);flex:1}
.ddoc-status{display:flex;align-items:center;gap:.4rem;font-size:.72rem;font-weight:700}
.ddoc-status.ok{color:var(--g)}
.ddoc-status.err{color:var(--r)}
.ddoc-status.warn{color:var(--y)}
.ddoc-status.pending{color:var(--tm)}
.ddoc-status.loading{color:var(--p)}
.dloading{width:10px;height:10px;border-radius:50%;border:1.5px solid rgba(141,51,255,.3);border-top-color:var(--p);animation:spin .8s linear infinite}
.dcard-footer{padding:.65rem 1rem;display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,.15)}
.dstatus{font-size:.72rem;font-weight:800;letter-spacing:.07em;text-transform:uppercase;display:flex;align-items:center;gap:.4rem}
.dstatus.apto{color:var(--g)}
.dstatus.inapto{color:var(--r)}
.dstatus.incompleto{color:var(--o)}
.dstatus.procesando{color:var(--p)}
.dstatus-dot{width:6px;height:6px;border-radius:50%;background:currentColor}
.dexp{font-size:.68rem;color:var(--tm)}

/* EMPTY STATE */
#empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4rem 2rem;text-align:center;color:var(--tm)}
#empty .ei{font-size:3.5rem;margin-bottom:1rem;opacity:.4}
#empty p{font-size:.9rem;max-width:320px;line-height:1.6}

/* BOTTOM ACTION BAR */
#action-bar{display:none;position:fixed;bottom:0;left:0;right:0;z-index:200;background:rgba(7,9,18,.95);backdrop-filter:blur(20px);border-top:1px solid var(--bd);padding:.9rem 2rem}
#action-bar.on{display:block}
.ab-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:1rem}
.ab-info{flex:1;font-size:.85rem;color:var(--tm)}
.ab-info strong{color:var(--t);font-weight:700}
.btn-upload{padding:.75rem 2rem;background:linear-gradient(135deg,var(--p),var(--c));color:#fff;border:none;border-radius:12px;font-size:.92rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:.5rem;transition:transform .2s,box-shadow .2s;white-space:nowrap}
.btn-upload:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(141,51,255,.4)}
.btn-upload:disabled{opacity:.5;cursor:default;transform:none}
.btn-sel-all{padding:.75rem 1.25rem;background:transparent;border:1px solid rgba(255,255,255,.1);color:var(--tm);border-radius:12px;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn-sel-all:hover{border-color:var(--p);color:var(--t)}

/* MODALS */
.modal-bg{display:none;position:fixed;inset:0;z-index:999;background:rgba(7,9,18,.92);backdrop-filter:blur(8px);align-items:center;justify-content:center}
.modal-bg.on{display:flex}
.modal{background:var(--s);border:1px solid var(--bd);border-radius:22px;padding:2rem;width:90%;max-width:440px}
.modal-title{font-size:1.2rem;font-weight:800;margin-bottom:.3rem}
.modal-sub{color:var(--tm);font-size:.84rem;margin-bottom:1.5rem;line-height:1.5}
.mrow{margin-bottom:1rem}
.mlabel{font-size:.72rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--tm);margin-bottom:.4rem;display:block}
.minput{width:100%;background:var(--s2);border:1px solid var(--bd);border-radius:10px;padding:.75rem 1rem;color:var(--t);font-size:.88rem;outline:none;transition:border-color .2s}
.minput:focus{border-color:var(--p)}
.msave{width:100%;padding:.85rem;background:linear-gradient(135deg,var(--p),var(--c));color:#fff;border:none;border-radius:12px;font-size:.9rem;font-weight:700;cursor:pointer;margin-top:.5rem}
.mcancel{width:100%;padding:.7rem;background:transparent;border:1px solid rgba(255,255,255,.1);color:var(--tm);border-radius:12px;font-size:.85rem;font-weight:600;cursor:pointer;margin-top:.5rem}

/* TOAST */
#toast{position:fixed;bottom:110px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--s);border:1px solid var(--bd);border-radius:12px;padding:.7rem 1.25rem;font-size:.84rem;font-weight:600;opacity:0;transition:all .3s;pointer-events:none;z-index:500;white-space:nowrap}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
#toast.ok{border-color:rgba(34,197,94,.4);color:var(--g)}
#toast.err{border-color:rgba(239,68,68,.4);color:var(--r)}
#toast.warn{border-color:rgba(245,158,11,.4);color:var(--y)}

/* LOG */
#dbg{display:none;background:#0A0D18;border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:.65rem 1rem;font-family:monospace;font-size:.7rem;color:#475569;margin-bottom:1rem;max-height:60px;overflow-y:auto}

@media(max-width:640px){.stats{grid-template-columns:repeat(3,1fr)}.ab-inner{flex-wrap:wrap}}

/* VIEW TOGGLE BUTTONS */
.btn-view{background:none;border:1px solid rgba(255,255,255,.1);color:var(--tm);border-radius:8px;padding:.32rem .65rem;font-size:.78rem;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:.35rem;line-height:1}
.btn-view:hover{border-color:var(--p);color:var(--t)}
.btn-view.active{background:rgba(141,51,255,.15);border-color:var(--p);color:var(--p)}

/* LIST VIEW â€” CSS Subgrid: each card spans all 6 tracks */
#driver-grid.list-view{grid-template-columns:215px 1fr 1fr 1fr 120px 120px !important;gap:4px 0 !important}
#driver-grid.list-view>.dcard,#driver-grid.list-view>#list-hdr-card{grid-column:1/-1;display:grid;grid-template-columns:subgrid;border-radius:10px}
/* dcard-docs spans middle 3 columns (2-4) with its own subgrid */
#driver-grid.list-view .dcard-docs{grid-column:2/5;display:grid;grid-template-columns:subgrid;padding:0;border-bottom:none}
/* COL 1 â€” Chofer */
#driver-grid.list-view .dcard-top{display:flex;align-items:center;gap:.65rem;padding:.55rem .85rem;background:var(--s2);border-bottom:none;border-right:1px solid var(--bd)}
#driver-grid.list-view .davatar{width:38px;height:38px;border-radius:9px;font-size:.82rem;flex-shrink:0}
#driver-grid.list-view .dname{font-size:.8rem}
#driver-grid.list-view .dcpf{font-size:.68rem}
/* COL 2,3,4 â€” Doc cells */
#driver-grid.list-view .ddoc{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.14rem;text-align:center;padding:.5rem .6rem;border-bottom:none;border-right:1px solid rgba(255,255,255,.08)}
#driver-grid.list-view .ddoc:last-child{border-right:none}
#driver-grid.list-view .ddoc-name{font-size:.6rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
#driver-grid.list-view .ddoc-icon{font-size:.95rem}
#driver-grid.list-view .ddoc-status{font-size:.64rem}
/* COL 5 â€” Persona badge */
#driver-grid.list-view .dcard-footer{grid-column:5;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.18rem;padding:.5rem .6rem;border-top:none;border-left:1px solid var(--bd)}
#driver-grid.list-view .dexp{font-size:.62rem}
/* COL 6 â€” Usuario badge */
#driver-grid.list-view .dcard-usuario{grid-column:6;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.18rem;padding:.5rem .6rem;border-top:none;border-left:1px solid var(--bd)}
/* Header row */
#list-hdr-card{display:none}
#driver-grid.list-view>#list-hdr-card{display:grid;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08)}
#driver-grid.list-view #list-hdr-card .dcard-top{background:transparent;border-right-color:rgba(255,255,255,.08);justify-content:center}
#driver-grid.list-view #list-hdr-card .ddoc{border-right-color:rgba(255,255,255,.1)}
#driver-grid.list-view #list-hdr-card .dcard-footer,#driver-grid.list-view #list-hdr-card .dcard-usuario{border-left-color:rgba(255,255,255,.08);align-items:center;justify-content:center}
.lhdr{font-size:.6rem;font-weight:700;color:var(--tm);text-transform:uppercase;letter-spacing:.07em;text-align:center}
/* Badge styles */
.badge{font-size:.62rem;font-weight:700;padding:.2rem .5rem;border-radius:6px;text-align:center;white-space:nowrap}
.badge.ok{background:rgba(34,197,94,.12);color:var(--g);border:1px solid rgba(34,197,94,.25)}
.badge.warn{background:rgba(245,158,11,.1);color:var(--y);border:1px solid rgba(245,158,11,.25)}
.badge.pend{background:rgba(100,116,139,.1);color:var(--tm);border:1px solid rgba(100,116,139,.2)}
.badge.err{background:rgba(239,68,68,.1);color:var(--r);border:1px solid rgba(239,68,68,.2)}
/* Excel entry tag */
.dcard.from-excel .dcard-top{border-left:3px solid var(--c)}
/* CPF collision warning */
.dcard.cpf-collision{outline:2px solid var(--y) !important;outline-offset:-2px}
.dcard.cpf-collision .dcard-top::after{content:'âš  CPF duplicado â€” revisÃ¡ el OCR';font-size:.58rem;color:var(--y);background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:5px;padding:.15rem .45rem;margin-left:auto;white-space:nowrap}
/* CPF unreadable warning */
.dcard.cpf-unreadable{outline:2px solid var(--r) !important;outline-offset:-2px}
.dcard.cpf-unreadable .dcard-top::after{content:'âš  CPF no legible â€” abrÃ­ el doc para verificar';font-size:.58rem;color:var(--r);background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);border-radius:5px;padding:.15rem .45rem;margin-left:auto;white-space:nowrap}
.excel-src{font-size:.58rem;color:var(--c);opacity:.7}
/* Stats grid 6 cols */
.stats{grid-template-columns:repeat(6,1fr) !important}
/* Excel tag */
.uz-tag.xls{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.25);color:var(--g)}
/* Clickable doc cells */
.doc-clickable{cursor:pointer;transition:background .15s}
.doc-clickable:hover{background:rgba(141,51,255,.08) !important}
.doc-clickable:hover .ddoc-name{color:var(--p)}

/* OCR Verification Modal */
#ocr-modal{display:none;align-items:center;justify-content:center;padding:1.5rem}
#ocr-modal.on{display:flex}
.ocr-modal-inner{background:#111827;border:1px solid rgba(141,51,255,.25);border-radius:18px;width:100%;max-width:920px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 24px 80px rgba(0,0,0,.7)}
.ocr-modal-hdr{display:flex;align-items:flex-start;justify-content:space-between;padding:1.1rem 1.4rem;border-bottom:1px solid rgba(255,255,255,.07);flex-shrink:0}
.ocr-modal-title{font-size:1rem;font-weight:700}
.ocr-modal-sub{font-size:.75rem;color:var(--tm);margin-top:.2rem}
.ocr-close{background:none;border:none;color:var(--tm);font-size:1.1rem;cursor:pointer;padding:.2rem .5rem;border-radius:6px;transition:color .15s}
.ocr-close:hover{color:var(--t)}
.ocr-modal-body{display:grid;grid-template-columns:1fr 1fr;flex:1;overflow:hidden;min-height:0}
.ocr-img-side{background:#0a0e1a;display:flex;flex-direction:column;border-right:1px solid rgba(255,255,255,.07);overflow:hidden;position:relative}
.ocr-zoom-wrap{flex:1;overflow:hidden;display:flex;align-items:center;justify-content:center;cursor:grab;user-select:none;position:relative}
.ocr-zoom-wrap.grabbing{cursor:grabbing}
.ocr-zoom-wrap img{transform-origin:0 0;border-radius:6px;max-width:none;pointer-events:none;will-change:transform}
.ocr-zoom-bar{display:flex;align-items:center;gap:.5rem;justify-content:center;padding:.5rem;border-top:1px solid rgba(255,255,255,.06);flex-shrink:0;background:#0a0e1a}
.ocr-zoom-bar button{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);color:var(--t);border-radius:6px;width:26px;height:26px;cursor:pointer;font-size:.95rem;display:flex;align-items:center;justify-content:center;transition:background .15s}
.ocr-zoom-bar button:hover{background:rgba(141,51,255,.25)}
.ocr-zoom-bar span{font-size:.72rem;color:var(--tm);min-width:38px;text-align:center}
.ocr-fields-side{padding:1.2rem 1.4rem;overflow-y:auto}
.ocr-fields-title{font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--tm);margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px solid rgba(255,255,255,.06)}
.ocr-field{display:flex;justify-content:space-between;align-items:baseline;gap:1rem;padding:.45rem 0;border-bottom:1px solid rgba(255,255,255,.04)}
.ocr-field:last-child{border-bottom:none}
.ocr-field-lbl{font-size:.72rem;color:var(--tm);flex-shrink:0}
.ocr-field-val{font-size:.8rem;font-weight:600;text-align:right;word-break:break-all}
.ocr-field-val.ok{color:var(--g)}
.ocr-field-val.err{color:var(--r)}
.ocr-field-val.warn{color:var(--y)}
.ocr-field-val.dim{color:var(--tm);font-weight:400}
.ocr-no-doc{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:.75rem;color:var(--tm);font-size:.85rem}

/* Column header tooltips */
.has-tip{position:relative;cursor:default}
.has-tip .tip{display:none;position:absolute;top:calc(100% + 8px);left:50%;transform:translateX(-50%);background:#1e2a3a;border:1px solid rgba(141,51,255,.3);border-radius:10px;padding:.65rem .85rem;font-size:.68rem;font-weight:400;color:var(--t);white-space:nowrap;line-height:1.7;z-index:200;box-shadow:0 8px 32px rgba(0,0,0,.5);pointer-events:none}
.has-tip .tip::before{content:'';position:absolute;top:-5px;left:50%;transform:translateX(-50%);width:8px;height:8px;background:#1e2a3a;border-left:1px solid rgba(141,51,255,.3);border-top:1px solid rgba(141,51,255,.3);rotate:45deg}
.has-tip:hover .tip{display:block}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <img src="data:image/png;base64,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" alt="VecFleet">
  <div class="hright">
    <span class="hpill">âœ¦ Eric Â· Alta Masiva</span>
    <div class="hdot"></div>
    <button class="igear" onclick="showSettings()" title="ConfiguraciÃ³n">âš™ï¸</button>
  </div>
</header>

<!-- KEY MODAL -->
<div class="modal-bg" id="key-modal">
  <div class="modal">
    <div class="modal-title">ğŸ”‘ API Key de Anthropic</div>
    <p class="modal-sub">IngresÃ¡ tu Anthropic API Key. Se guarda en tu navegador y no se comparte.</p>
    <div class="mrow">
      <label class="mlabel">API Key</label>
      <input class="minput" id="kinput" type="password" placeholder="sk-ant-api03-..." autocomplete="off">
    </div>
    <button class="msave" onclick="saveKey()">Guardar y continuar â†’</button>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-bg" id="settings-modal">
  <div class="modal">
    <div class="modal-title">âš™ï¸ ConfiguraciÃ³n</div>
    <p class="modal-sub">AjustÃ¡ los parÃ¡metros de validaciÃ³n para este cliente.</p>
    <div class="mrow">
      <label class="mlabel">Vigencia del entrenamiento (meses)</label>
      <input class="minput" id="s-months" type="number" min="1" max="60" value="12">
    </div>
    <div class="mrow">
      <label class="mlabel">Endpoint VecFleet (opcional)</label>
      <input class="minput" id="s-endpoint" type="text" placeholder="https://api.vecfleet.io/v1/choferes/alta">
    </div>
    <div class="mrow">
      <label class="mlabel">API Key de Anthropic</label>
      <input class="minput" id="s-key" type="password" placeholder="sk-ant-api03-...">
    </div>
    <button class="msave" onclick="saveSettings()">Guardar configuraciÃ³n</button>
    <button class="mcancel" onclick="closeSettings()">Cancelar</button>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<main>
  <h1 class="page-title">Alta Masiva <span class="gr">con Eric</span></h1>
  <p class="page-sub">SubÃ­ CNH, exÃ¡menes toxicolÃ³gicos y certificados de entrenamiento â€” Eric los clasifica y valida automÃ¡ticamente.</p>

  <!-- UPLOAD ZONE -->
  <div class="upload-zone" id="upzone" ondragover="onDrag(event)" ondragleave="onUndrag()" ondrop="onDrop(event)">
    <input type="file" accept="image/*,application/pdf,.xlsx,.xls" multiple id="file-input" onchange="onFiles(event)">
    <div class="uz-icon">ğŸ“‚</div>
    <div class="uz-title">ArrastrÃ¡ archivos o hacÃ© click para seleccionar</div>
    <div class="uz-sub">PodÃ©s subir todos los documentos juntos o de a uno â€” Eric detecta el tipo automÃ¡ticamente</div>
    <div class="uz-types">
      <span class="uz-tag">ğŸªª CNH</span>
      <span class="uz-tag tox">ğŸ”¬ ToxicolÃ³gico</span>
      <span class="uz-tag ent">ğŸ“ Entrenamiento</span>
      <span class="uz-tag pdf">PDF</span>
      <span class="uz-tag pdf">JPG</span>
      <span class="uz-tag pdf">PNG</span>
      <span class="uz-tag xls">ğŸ“Š Excel</span>
    </div>
  </div>

  <!-- DEBUG LOG -->
  <div id="dbg"></div>

  <!-- QUEUE INDICATOR -->
  <div id="queue-bar"><div class="qspin"></div><span id="queue-txt">Procesando archivosâ€¦</span></div>

  <!-- STATS -->
  <div class="stats" id="stats-bar" style="display:none">
    <div class="stat"><div class="stat-num" id="st-total">0</div><div class="stat-lbl">Personas</div></div>
    <div class="stat"><div class="stat-num" id="st-files">0</div><div class="stat-lbl">Archivos</div></div>
    <div class="stat"><div class="stat-num green" id="st-apto">0</div><div class="stat-lbl">Docs OK</div></div>
    <div class="stat"><div class="stat-num" id="st-persona">0</div><div class="stat-lbl">Crear Persona</div></div>
    <div class="stat"><div class="stat-num" id="st-usuario">0</div><div class="stat-lbl">Crear Usuario</div></div>
    <div class="stat"><div class="stat-num yellow" id="st-pend">0</div><div class="stat-lbl">Pendientes</div></div>
  </div>

  <!-- GRID HEADER -->
  <div class="grid-header" id="grid-header" style="display:none">
    <div class="grid-title">Choferes procesados</div>
    <div class="grid-actions">
      <button class="btn-sm" onclick="filterCards('all')" id="f-all">Todos</button>
      <button class="btn-sm" onclick="filterCards('apto')" id="f-apto">Aptos</button>
      <button class="btn-sm" onclick="filterCards('inapto')" id="f-inapto">No aptos</button>
      <span style="width:1px;background:rgba(255,255,255,.08);align-self:stretch;margin:0 .15rem"></span>
      <button class="btn-view" id="v-card" onclick="toggleView('card')" title="Vista tarjetas">
        <svg width="13" height="13" viewBox="0 0 16 16" fill="currentColor"><rect x="0" y="0" width="7" height="7" rx="1.5"/><rect x="9" y="0" width="7" height="7" rx="1.5"/><rect x="0" y="9" width="7" height="7" rx="1.5"/><rect x="9" y="9" width="7" height="7" rx="1.5"/></svg>
        Tarjetas
      </button>
      <button class="btn-view active" id="v-list" onclick="toggleView('list')" title="Vista lista">
        <svg width="13" height="13" viewBox="0 0 16 16" fill="currentColor"><rect x="0" y="1" width="16" height="2.5" rx="1.2"/><rect x="0" y="6.75" width="16" height="2.5" rx="1.2"/><rect x="0" y="12.5" width="16" height="2.5" rx="1.2"/></svg>
        Lista
      </button>
    </div>
  </div>

  <!-- DRIVER GRID (first child = header row, always inside grid for perfect column alignment) -->
  <div id="driver-grid">
    <div id="list-hdr-card">
      <div class="dcard-top"><span class="lhdr">Chofer</span></div>
      <div class="dcard-docs">
        <div class="ddoc"><span class="lhdr">CNH / Licencia</span></div>
        <div class="ddoc"><span class="lhdr">ToxicolÃ³gico</span></div>
        <div class="ddoc"><span class="lhdr">Entrenamiento</span></div>
      </div>
      <div class="dcard-footer">
        <span class="lhdr has-tip">Persona
          <span class="tip">
            <b>â— INCOMPLETO</b> â€” esperando PDFs<br>
            <b>â— PROCESANDOâ€¦</b> â€” analizando docs<br>
            <b>â— NO APTO</b> â€” doc vencido o positivo<br>
            <b>â— APTO</b> â€” CNH + Tox + Entrena. OK âœ“
          </span>
        </span>
      </div>
      <div class="dcard-usuario">
        <span class="lhdr has-tip">Usuario
          <span class="tip">
            <b>â³ Docs pendientes</b> â€” persona no apta aÃºn<br>
            <b>âœ— No apto</b> â€” docs vencidos<br>
            <b>âš  Sin email</b> â€” falta email en Excel<br>
            <b>âš  Falta datos</b> â€” falta transportadora<br>
            <b>âœ“ LISTO</b> â€” apto + email + transportadora âœ“
          </span>
        </span>
      </div>
    </div>
  </div>

  <!-- OCR VERIFICATION MODAL -->
  <div class="modal-bg" id="ocr-modal" onclick="closeOcrModal(event)">
    <div class="ocr-modal-inner">
      <div class="ocr-modal-hdr">
        <div>
          <div class="ocr-modal-title" id="ocr-title">VerificaciÃ³n de documento</div>
          <div class="ocr-modal-sub" id="ocr-sub"></div>
        </div>
        <button class="ocr-close" onclick="closeOcrModal(null)">âœ•</button>
      </div>
      <div class="ocr-modal-body">
        <div class="ocr-img-side" id="ocr-img-side">
          <div class="ocr-zoom-wrap" id="ocr-zoom-wrap">
            <img id="ocr-img" src="" alt="Documento original" draggable="false">
          </div>
          <div class="ocr-zoom-bar">
            <button onclick="zoomDoc(-0.25)" title="Alejar">âˆ’</button>
            <span id="ocr-zoom-pct">100%</span>
            <button onclick="zoomDoc(+0.25)" title="Acercar">+</button>
            <button onclick="resetZoom()" title="Restablecer">âŠ¡</button>
          </div>
        </div>
        <div class="ocr-fields-side">
          <div class="ocr-fields-title">Campos extraÃ­dos por OCR</div>
          <div id="ocr-fields"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- EMPTY STATE -->
  <div id="empty">
    <div class="ei">ğŸ“‹</div>
    <p>SubÃ­ los documentos de los choferes para comenzar el anÃ¡lisis con Eric</p>
  </div>
</main>

<!-- BOTTOM ACTION BAR -->
<div id="action-bar">
  <div class="ab-inner">
    <div class="ab-info"><strong id="ab-count">0 choferes</strong> seleccionados para alta</div>
    <button class="btn-sel-all" onclick="selectAllApto()">Seleccionar todos los aptos</button>
    <button class="btn-upload" onclick="uploadSelected()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 1 4 4c0 1.5-.8 2.8-2 3.5V11h2a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h-2v1.5c1.2.7 2 2 2 3.5a4 4 0 0 1-8 0c0-1.5.8-2.8 2-3.5V16H8a2 2 0 0 1-2-2v-1a2 2 0 0 1 2-2h2V9.5C8.8 8.8 8 7.5 8 6a4 4 0 0 1 4-4z"/></svg>
      Cargar con Eric
    </button>
  </div>
</div>

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let K = localStorage.getItem('vf_api_key') || '';
let CFG = {
  months: parseInt(localStorage.getItem('vf_months') || '12'),
  endpoint: localStorage.getItem('vf_endpoint') || ''
};
const MDL = 'claude-sonnet-4-5-20250929'; // Sonnet: mejor precisiÃ³n OCR para datos sensibles (CPF, fechas)
const MAX_CONCURRENT = 1; // Sequential: avoids Anthropic API rate limits (429)
const API_THROTTLE_MS = 6000; // Sonnet tiene lÃ­mites mÃ¡s bajos â€” 6s entre llamadas para mayor seguridad

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DRIVERS = {};   // { key: { name, cpf, photo, docs:{cnh,tox,train}, email, transportadora, ... } }
const EXCEL_POOL = {};    // { cnhNum: excelRowData }
const EXCEL_BY_NAME = {}; // { normalizedName: excelRowData } â€” fallback matching
let QUEUE = [];
let ACTIVE = 0;
let TOTAL_FILES = 0;
let DONE_FILES = 0;
let currentFilter = 'all';
let VIEW_MODE = 'list';

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', () => { if (!K) showKeyModal(); });

function log(m) {
  const d = document.getElementById('dbg');
  d.style.display = 'block';
  d.textContent = new Date().toLocaleTimeString() + ' ' + m;
  console.log(m);
}

function toast(msg, type='ok') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'show ' + type;
  setTimeout(() => t.className = '', 3000);
}

// â”€â”€â”€ KEY / SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showKeyModal() { document.getElementById('key-modal').classList.add('on'); }
function saveKey() {
  const v = document.getElementById('kinput').value.trim();
  if (!v) return;
  K = v; localStorage.setItem('vf_api_key', v);
  document.getElementById('key-modal').classList.remove('on');
}
function showSettings() {
  document.getElementById('s-months').value = CFG.months;
  document.getElementById('s-endpoint').value = CFG.endpoint;
  document.getElementById('s-key').value = K;
  document.getElementById('settings-modal').classList.add('on');
}
function closeSettings() { document.getElementById('settings-modal').classList.remove('on'); }
function saveSettings() {
  const m = parseInt(document.getElementById('s-months').value) || 12;
  const ep = document.getElementById('s-endpoint').value.trim();
  const key = document.getElementById('s-key').value.trim();
  CFG.months = m; CFG.endpoint = ep;
  localStorage.setItem('vf_months', m);
  localStorage.setItem('vf_endpoint', ep);
  if (key) { K = key; localStorage.setItem('vf_api_key', key); }
  closeSettings();
  toast('ConfiguraciÃ³n guardada âœ“');
}

// â”€â”€â”€ FILE HANDLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onDrag(e) { e.preventDefault(); document.getElementById('upzone').classList.add('drag'); }
function onUndrag() { document.getElementById('upzone').classList.remove('drag'); }
function onDrop(e) {
  e.preventDefault(); onUndrag();
  handleFiles([...e.dataTransfer.files]);
}
function onFiles(e) { handleFiles([...e.target.files]); e.target.value = ''; }

function isExcel(f) { return f.name.match(/\.xlsx?$/i) || f.type.includes('spreadsheet'); }

function handleFiles(files) {
  const excelFiles = files.filter(isExcel);
  const docFiles = files.filter(f => !isExcel(f) && (f.type.startsWith('image/') || f.type === 'application/pdf'));

  excelFiles.forEach(f => processExcel(f));

  if (docFiles.length) {
    if (!K) { showKeyModal(); return; }
    if (QUEUE.length > 0 || ACTIVE > 0) {
      toast('â³ EsperÃ¡ a que terminen los archivos actuales antes de subir mÃ¡s', 'warn');
      return;
    }
    showGrid();
    TOTAL_FILES += docFiles.length;
    DONE_FILES = 0; // reset counter for new batch
    docFiles.forEach(f => QUEUE.push(f));
    setUpzoneLocked(true);
    updateQueueBar();
    for (let i = 0; i < MAX_CONCURRENT; i++) processNext();
  } else if (excelFiles.length) {
    showGrid();
  }
}

function setUpzoneLocked(locked) {
  const uz = document.getElementById('upzone');
  const inp = document.getElementById('file-input');
  uz.classList.toggle('locked', locked);
  inp.disabled = locked;
}

function showGrid() {
  document.getElementById('empty').style.display = 'none';
  document.getElementById('stats-bar').style.display = '';
  document.getElementById('grid-header').style.display = '';
  if (!document.getElementById('driver-grid').classList.contains('list-view')) {
    document.getElementById('driver-grid').classList.add('list-view');
  }
}

// â”€â”€â”€ EXCEL PROCESSING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function normalizeName(name) {
  return String(name || '').toUpperCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .replace(/\s+/g, ' ').trim();
}

function findDriverCpfByName(name) {
  const norm = normalizeName(name);
  return Object.keys(DRIVERS).find(k => !k.startsWith('EX_') && normalizeName(DRIVERS[k].name) === norm) || null;
}

function mergeExcelData(key, ex) {
  const d = DRIVERS[key];
  if (!d) return;
  d.email = d.email || ex.email || null;
  d.transportadora = d.transportadora || ex.transportadora || null;
  d.base = d.base || ex.base || null;
  d.perfil = d.perfil || ex.perfil || null;
  d.categoria = d.categoria || ex.categoria || null;
  d.cnh_num = d.cnh_num || ex.cnh_num || null;
  d.es_usuario = d.es_usuario || ex.es_usuario || false;
  d.fromExcel = true;
  if (d.el) d.el.classList.add('from-excel');
  updateCard(key);
}

async function processExcel(file) {
  log('Procesando Excel: ' + file.name);
  try {
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type: 'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

    let added = 0, matched = 0;
    rows.forEach(row => {
      const cnhNum = String(row['documento_numero'] || '').replace(/\s/g,'').trim();
      const name = [row['nome'], row['sobrenome']].filter(Boolean).join(' ').trim().toUpperCase();
      if (!cnhNum && !name) return;

      const ex = {
        name,
        email: row['email'] || null,
        transportadora: row['Transportadora'] || null,
        base: row['base'] || null,
        perfil: row['perfil'] || null,
        categoria: row['Categoria'] || null,
        cnh_num: cnhNum,
        rg: String(row['legajo_numero (RG)'] || ''),
        es_usuario: String(row['es_usuario'] || '').toLowerCase() === 'si',
      };

      if (cnhNum) EXCEL_POOL[cnhNum] = ex;
      if (name) EXCEL_BY_NAME[normalizeName(name)] = ex;

      // Try to match to an already-processed CPF driver by name
      const existingCpf = findDriverCpfByName(name);
      if (existingCpf) {
        mergeExcelData(existingCpf, ex);
        matched++;
        return;
      }

      // Create Excel-only pending entry
      const exKey = 'EX_' + (cnhNum || normalizeName(name));
      if (!DRIVERS[exKey]) {
        DRIVERS[exKey] = {
          name, cpf: null, exKey, photo: null,
          docs: { cnh: null, tox: null, train: null },
          el: null, fromExcel: true, ...ex
        };
        createCard(exKey);
        added++;
      }
    });

    updateStats();
    log(`Excel: ${added} nuevas personas, ${matched} enlazadas con docs existentes`);
    toast(`âœ“ Excel importado: ${rows.length} personas (${matched} ya con docs procesados)`);
  } catch(e) {
    log('Error al leer Excel: ' + e.message);
    toast('Error al leer el Excel: ' + e.message, 'err');
  }
}

async function processNext() {
  if (ACTIVE >= MAX_CONCURRENT || QUEUE.length === 0) return;
  const file = QUEUE.shift();
  ACTIVE++;
  updateQueueBar();
  try { await processFile(file); }
  catch(e) { log('Error: ' + e.message); }
  finally {
    ACTIVE--; DONE_FILES++;
    updateQueueBar();
    setTimeout(processNext, API_THROTTLE_MS); // throttle to prevent 429 rate limit errors
  }
}

function updateQueueBar() {
  const bar = document.getElementById('queue-bar');
  const remaining = QUEUE.length + ACTIVE;
  if (remaining > 0) {
    bar.classList.add('on');
    document.getElementById('queue-txt').textContent =
      `Procesando ${DONE_FILES}/${TOTAL_FILES} archivos â€” ${remaining} en cola`;
  } else {
    bar.classList.remove('on');
    setUpzoneLocked(false); // re-enable drop zone when queue finishes
    if (DONE_FILES > 0) updateStats();
  }
}

// â”€â”€â”€ PDF â†’ IMAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pdfToImage(file) {
  const lib = window['pdfjs-dist/build/pdf'];
  lib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  const buf = await file.arrayBuffer();
  const pdf = await lib.getDocument({ data: buf }).promise;

  // Page 1 canvas â†’ used for OCR (send to Claude) + face detection
  const page1 = await pdf.getPage(1);
  const vp1 = page1.getViewport({ scale: 1.8 });
  const canvas = document.createElement('canvas');
  canvas.width = vp1.width; canvas.height = vp1.height;
  await page1.render({ canvasContext: canvas.getContext('2d'), viewport: vp1 }).promise;

  // All-pages preview â†’ stacked vertically at 3x (higher res than OCR) for the verification modal
  const numPages = pdf.numPages;
  let totalH = 0, pageCanvases = [];
  for (let i = 1; i <= numPages; i++) {
    const pg = await pdf.getPage(i);
    const vp = pg.getViewport({ scale: 3.0 }); // 3x for sharp zoom in modal
    const c = document.createElement('canvas');
    c.width = vp.width; c.height = vp.height;
    await pg.render({ canvasContext: c.getContext('2d'), viewport: vp }).promise;
    pageCanvases.push(c);
    totalH += vp.height + (i < numPages ? 16 : 0); // 16px gap between pages
  }
  const previewCanvas = document.createElement('canvas');
  previewCanvas.width = pageCanvases[0].width;
  previewCanvas.height = totalH;
  const ctx = previewCanvas.getContext('2d');
  ctx.fillStyle = '#1a1f2e';
  ctx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);
  let y = 0;
  for (const pc of pageCanvases) {
    ctx.drawImage(pc, 0, y);
    y += pc.height + 16;
  }
  const previewDataUrl = previewCanvas.toDataURL('image/jpeg', 0.92);

  const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
  return {
    dataUrl,       // page 1 only â€” for OCR
    previewDataUrl, // all pages stacked â€” for modal preview
    canvas,
    blob: await new Promise(r => canvas.toBlob(b => r(b), 'image/jpeg', 0.92))
  };
}

async function imageToCanvas(file) {
  return new Promise(res => {
    const img = new Image();
    const url = URL.createObjectURL(file);
    img.onload = () => {
      const c = document.createElement('canvas');
      c.width = img.naturalWidth; c.height = img.naturalHeight;
      c.getContext('2d').drawImage(img, 0, 0);
      URL.revokeObjectURL(url);
      res(c);
    };
    img.onerror = () => { URL.revokeObjectURL(url); res(null); };
    img.src = url;
  });
}

// â”€â”€â”€ FACE DETECTION (face-api.js lazy load) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _faceApiReady = false, _faceApiLoading = null;
async function initFaceApi() {
  if (_faceApiReady) return true;
  if (_faceApiLoading) return _faceApiLoading;
  _faceApiLoading = (async () => {
    if (!window.faceapi) {
      await new Promise((ok, fail) => {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js';
        s.onload = ok; s.onerror = fail;
        document.head.appendChild(s);
      });
    }
    await faceapi.nets.tinyFaceDetector.loadFromUri(
      'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights'
    );
    _faceApiReady = true; return true;
  })().catch(e => { console.warn('face-api init failed:', e); return false; });
  return _faceApiLoading;
}

async function detectAndCropFace(canvas, isPdf = false) {
  if (!canvas) return null;
  if (!await initFaceApi()) return null;

  // Extract a sub-region from a canvas (normalized coords)
  function subCrop(src, nx, ny, nw, nh) {
    const px = Math.round(nx * src.width), py = Math.round(ny * src.height);
    const pw = Math.round(nw * src.width), ph = Math.round(nh * src.height);
    if (pw < 30 || ph < 30) return null;
    const c = document.createElement('canvas');
    c.width = pw; c.height = ph;
    c.getContext('2d').drawImage(src, px, py, pw, ph, 0, 0, pw, ph);
    return c;
  }

  // Extract padded face from original canvas using detected box + optional offset
  function extractFace(src, box, offX = 0, offY = 0) {
    const pad = 0.35;
    const x = box.x + offX, y = box.y + offY, w = box.width, h = box.height;
    const rx = Math.max(0, x - w * pad);
    const ry = Math.max(0, y - h * pad);
    const rw = Math.min(src.width - rx, w * (1 + pad * 2));
    const rh = Math.min(src.height - ry, h * (1 + pad * 2));
    if (rw < 20 || rh < 20) return null;
    const dst = document.createElement('canvas');
    dst.width = rw; dst.height = rh;
    dst.getContext('2d').drawImage(src, rx, ry, rw, rh, 0, 0, rw, rh);
    return dst.toDataURL('image/jpeg', 0.92);
  }

  async function detect(c, inputSize, score) {
    try { return await faceapi.detectSingleFace(c, new faceapi.TinyFaceDetectorOptions({ inputSize, scoreThreshold: score })); }
    catch(e) { return null; }
  }

  // Attempt 1: full image â€” works for real CNH card photos
  let det = await detect(canvas, 416, 0.22);
  if (det) return extractFace(canvas, det.box);

  // Attempt 2: crop to left 47% Ã— top 50% of page â€” PDF format has CNH card thumbnail there
  // Face in card becomes ~22% of crop width â†’ detectable at inputSize=416
  const cardOffY = Math.round(0.03 * canvas.height);
  const cardCrop = subCrop(canvas, 0, 0.03, 0.47, 0.50);
  if (cardCrop) {
    det = await detect(cardCrop, 416, 0.18);
    if (det) return extractFace(canvas, det.box, 0, cardOffY);
  }

  // Attempt 3 (PDF only): tight crop on known face region in SENATRAN/DENATRAN digital format
  // Face photo is always in upper-left of the card thumbnail: ~x=3-22%, y=8-28% of page
  if (isPdf) {
    const faceCrop = subCrop(canvas, 0.03, 0.08, 0.20, 0.21);
    if (faceCrop) {
      det = await detect(faceCrop, 224, 0.12);
      if (det) return extractFace(faceCrop, det.box);
      // Last resort: use the known face region directly â€” better than initials for PDF CNH
      return faceCrop.toDataURL('image/jpeg', 0.92);
    }
  }

  return null; // â†’ show initials
}

function b64(blob) {
  return new Promise((r, j) => {
    const rd = new FileReader();
    rd.onload = () => r(rd.result.split(',')[1]);
    rd.onerror = j;
    rd.readAsDataURL(blob);
  });
}

// â”€â”€â”€ PROCESS FILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function processFile(file) {
  log('Procesando: ' + file.name);
  let imageB64, mimeType, previewUrl, pageCanvas = null, isPdf = false;

  if (file.type === 'application/pdf') {
    const { dataUrl, previewDataUrl, blob, canvas } = await pdfToImage(file);
    imageB64 = await b64(blob);
    mimeType = 'image/jpeg';
    previewUrl = previewDataUrl; // all pages stacked for modal; dataUrl (pg1) used for OCR
    pageCanvas = canvas;
    isPdf = true;
  } else {
    imageB64 = await b64(file);
    mimeType = file.type || 'image/jpeg';
    previewUrl = URL.createObjectURL(file);
    pageCanvas = await imageToCanvas(file);
  }

  const result = await callClaude(imageB64, mimeType);
  if (!result) return;

  log('Resultado: ' + result.type + ' â€” ' + (result.name || '?') + ' CPF:' + (result.cpf || '?'));

  // For CNH, detect and crop the face photo using ML (face-api.js)
  let facePhoto = null;
  if (result.type === 'CNH' && pageCanvas) {
    log('Detectando cara...');
    facePhoto = await detectAndCropFace(pageCanvas, isPdf);
    log(facePhoto ? 'Cara detectada âœ“' : 'Sin cara detectada');
  }
  applyResult(result, previewUrl, facePhoto);
}

// â”€â”€â”€ CLAUDE API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function callClaude(imageB64, mimeType) {
  const today = new Date().toISOString().split('T')[0];
  const prompt = `Sos un motor OCR para documentos de habilitaciÃ³n de conductores en Brasil.
AnalizÃ¡ la imagen y clasificÃ¡ el tipo de documento. La fecha de hoy es ${today}.

TIPOS POSIBLES:
1. CNH (Carteira Nacional de HabilitaÃ§Ã£o) â€” licencia de conducir brasileÃ±a
2. TOXICOLOGY â€” Laudo de AnÃ¡lise ToxicolÃ³gica
3. TRAINING â€” Certificado de curso de direÃ§Ã£o segura / defensiva (SEST SENAT u otro)
4. UNKNOWN â€” cualquier otro documento

DevolvÃ© ÃšNICAMENTE JSON vÃ¡lido sin texto adicional:

Para CNH: {"type":"CNH","name":"","cpf":"","dob":"","validity":"","category":"","issuer_state":"","registro":"","status":"VALID_OR_EXPIRED"}
Para TOXICOLOGY: {"type":"TOXICOLOGY","name":"","cpf":"","result":"NEGATIVE_OR_POSITIVE","validity_date":"","collection_date":"","lab":"","is_valid":true}
Para TRAINING: {"type":"TRAINING","name":"","cpf":"","course":"","institution":"","completion_date":""}
Para UNKNOWN: {"type":"UNKNOWN","detected":"descripcion breve"}

Reglas:
- CPF: solo los nÃºmeros con puntos y guiÃ³n (ej: "044.829.105-38") o null
- Fechas en formato YYYY-MM-DD
- status CNH: "VALID" si validity > ${today}, "EXPIRED" si no
- is_valid toxicologÃ­a: true si resultado final es negativo (NÃ£o Detectado) y validity_date > ${today}
- registro CNH: NÂº Registro (Renach) que aparece en la CNH â€” solo dÃ­gitos, sin puntos ni espacios, o null
- null para campos no visibles`;

  const body = JSON.stringify({
    model: MDL, max_tokens: 600,
    messages: [{ role: 'user', content: [
      { type: 'image', source: { type: 'base64', media_type: mimeType, data: imageB64 } },
      { type: 'text', text: prompt }
    ]}]
  });
  const headers = {
    'x-api-key': K, 'anthropic-version': '2023-06-01',
    'content-type': 'application/json',
    'anthropic-dangerous-direct-browser-access': 'true'
  };
  // Retry up to 5 times on 429 â€” respects retry-after header (Anthropic resets every ~60s)
  for (let attempt = 0; attempt < 5; attempt++) {
    try {
      const resp = await fetch('https://api.anthropic.com/v1/messages', { method: 'POST', headers, body });
      if (resp.status === 429) {
        if (attempt >= 4) { log('Rate limit: mÃ¡ximo de reintentos alcanzado'); return null; }
        // Respect the retry-after header; fall back to 65s if not present
        const retryAfter = parseInt(resp.headers.get('retry-after') || '65', 10);
        const waitSec = Math.max(retryAfter, 15); // always wait at least 15s
        log(`â³ Rate limit â€” reintentando en ${waitSec}s (intento ${attempt+1}/5)â€¦`);
        await new Promise(r => setTimeout(r, waitSec * 1000));
        continue;
      }
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const data = await resp.json();
      const raw = data.content[0].text.trim();
      const clean = raw.replace(/```json|```/g, '').trim();
      return JSON.parse(clean);
    } catch (e) {
      log('Claude error: ' + e.message);
      if (attempt >= 4) return null;
    }
  }
  return null;
}

// â”€â”€â”€ APPLY RESULT TO DRIVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyResult(result, previewUrl, facePhoto) {
  if (result.type === 'UNKNOWN') {
    log('Documento no reconocido: ' + result.detected);
    toast('Documento no reconocido: ' + result.detected, 'err');
    return;
  }

  const cpf = normalizeCpf(result.cpf);

  // CPF unreadable: don't discard â€” create a temp entry so the user can review it
  if (!cpf) {
    const tmpName = normalizeName(result.name || '');
    const tmpKey = 'NOCPF_' + (tmpName || Date.now());
    log(`âš  CPF no legible para "${result.name || 'desconocido'}" â€” entrada temporal creada`);
    toast(`âš  CPF no legible para "${result.name || 'doc'}" â€” hacÃ© click en CNH para verificar`, 'warn');
    if (!DRIVERS[tmpKey]) {
      DRIVERS[tmpKey] = {
        name: result.name || 'â€”', cpf: tmpKey, photo: null,
        docs: { cnh: null, tox: null, train: null }, el: null,
        email: null, transportadora: null, base: null, perfil: null,
        categoria: null, cnh_num: null, es_usuario: false, fromExcel: false,
        cpfUnreadable: true
      };
      createCard(tmpKey);
    }
    const tmpDriver = DRIVERS[tmpKey];
    if (result.name && result.name.length > 2) tmpDriver.name = result.name;
    result._preview = previewUrl;
    if (result.type === 'CNH') {
      tmpDriver.docs.cnh = result;
      if (!tmpDriver.photo) tmpDriver.photo = facePhoto || null;
    } else if (result.type === 'TOXICOLOGY') {
      tmpDriver.docs.tox = result;
    } else if (result.type === 'TRAINING') {
      tmpDriver.docs.train = result;
    }
    if (tmpDriver.el) tmpDriver.el.classList.add('cpf-unreadable');
    updateCard(tmpKey);
    updateStats();
    return;
  }

  // Create driver if new
  if (!DRIVERS[cpf]) {
    DRIVERS[cpf] = {
      name: result.name || 'â€”', cpf, photo: null,
      docs: { cnh: null, tox: null, train: null }, el: null,
      email: null, transportadora: null, base: null, perfil: null,
      categoria: null, cnh_num: null, es_usuario: false, fromExcel: false
    };
    createCard(cpf);
  }

  const driver = DRIVERS[cpf];

  // Detect CPF collision: same CPF but different name on a CNH â†’ likely OCR error
  if (result.type === 'CNH' && driver.docs.cnh && result.name && driver.name) {
    const existingNorm = normalizeName(driver.name);
    const newNorm = normalizeName(result.name);
    if (existingNorm !== newNorm) {
      const msg = `âš  CPF duplicado: ${cpf}\n"${driver.name}" â†’ "${result.name}"\nVerificÃ¡ el OCR en ambos documentos.`;
      log('âš  CPF DUPLICADO: ' + driver.name + ' / ' + result.name + ' â†’ ' + cpf);
      toast(`âš  CPF duplicado para "${result.name}" â€” revisÃ¡ el OCR`, 'warn');
      // Mark the card so it's visually flagged
      if (driver.el) driver.el.classList.add('cpf-collision');
    }
  }

  if (result.name && result.name.length > 2) driver.name = result.name;

  // Attach preview URL to result for OCR verification modal
  result._preview = previewUrl;

  if (result.type === 'CNH') {
    driver.docs.cnh = result;
    if (result.registro) driver.cnh_num = result.registro;
    if (!driver.photo) driver.photo = facePhoto || null;

    // Try to match Excel data by NÂº Registro or name
    const exData = (result.registro && EXCEL_POOL[result.registro])
      || EXCEL_BY_NAME[normalizeName(result.name || '')];
    if (exData) {
      mergeExcelData(cpf, exData);
      // Remove the Excel-only pending card if it exists
      const exKey = 'EX_' + (exData.cnh_num || normalizeName(exData.name));
      if (DRIVERS[exKey]) {
        if (DRIVERS[exKey].el) DRIVERS[exKey].el.remove();
        delete DRIVERS[exKey];
      }
    }
  } else if (result.type === 'TOXICOLOGY') {
    driver.docs.tox = result;
  } else if (result.type === 'TRAINING') {
    driver.docs.train = result;
    // Also try name matching for training (no cnhnum available)
    if (!driver.fromExcel) {
      const exData = EXCEL_BY_NAME[normalizeName(result.name || '')];
      if (exData) mergeExcelData(cpf, exData);
    }
  }

  updateCard(cpf);
  updateStats();
}

function normalizeCpf(cpf) {
  if (!cpf) return null;
  const nums = cpf.replace(/\D/g, '');
  if (nums.length !== 11) return null;
  return nums.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
}

// â”€â”€â”€ VALIDATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isDocValid(driver, type) {
  const today = new Date();
  if (type === 'cnh') {
    const d = driver.docs.cnh;
    if (!d) return null;
    return d.status === 'VALID';
  }
  if (type === 'tox') {
    const d = driver.docs.tox;
    if (!d) return null;
    if (d.result === 'POSITIVE') return false;
    if (!d.validity_date) return d.is_valid !== false;
    return new Date(d.validity_date) > today;
  }
  if (type === 'train') {
    const d = driver.docs.train;
    if (!d) return null;
    if (!d.completion_date) return true;
    const cutoff = new Date();
    cutoff.setMonth(cutoff.getMonth() - CFG.months);
    return new Date(d.completion_date) > cutoff;
  }
  return null;
}

function driverStatus(cpf) {
  const d = DRIVERS[cpf];
  const cnhOk = isDocValid(d, 'cnh');
  const toxOk = isDocValid(d, 'tox');
  const trainOk = isDocValid(d, 'train');
  // Excel-only entries have no docs yet â€” show as incomplete, not "processing"
  if (cnhOk === null && toxOk === null && trainOk === null) return d.fromExcel ? 'incompleto' : 'procesando';
  if (cnhOk === false || toxOk === false || trainOk === false) return 'inapto';
  if (cnhOk && toxOk && trainOk) return 'apto';
  return 'incompleto';
}

// â”€â”€â”€ CARD UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createCard(cpf) {
  const d = DRIVERS[cpf];
  const el = document.createElement('div');
  el.className = 'dcard'; el.id = 'card-' + cpf.replace(/\D/g,'');
  el.innerHTML = cardHTML(cpf);
  document.getElementById('driver-grid').appendChild(el);
  d.el = el;
  setTimeout(() => el.classList.add('show'), 30);
}

function cardHTML(cpf) {
  const d = DRIVERS[cpf];
  const safeId = cpf.replace(/\W/g,'_');
  const initials = (d.name || '??').split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();
  const photo = d.photo ? `<img src="${d.photo}" alt="">` : initials;
  const subtitle = d.cpf ? d.cpf : (d.cnh_num ? 'CNH ' + d.cnh_num : '');
  const excelSrc = d.fromExcel ? `<span class="excel-src">ğŸ“Š Excel</span>` : '';
  return `
    <div class="dcard-top">
      <div class="dcard-check" id="chk-${safeId}" onclick="toggleSelect('${cpf}')"></div>
      <div class="davatar" id="av-${safeId}">${photo}</div>
      <div class="dinfo">
        <div class="dname" id="dn-${safeId}">${d.name}</div>
        <div class="dcpf">${subtitle}</div>
        ${excelSrc}
      </div>
    </div>
    <div class="dcard-docs">
      ${docRow('cnh','ğŸªª','CNH / Licencia',cpf)}
      ${docRow('tox','ğŸ”¬','ToxicolÃ³gico',cpf)}
      ${docRow('train','ğŸ“','Entrenamiento',cpf)}
    </div>
    <div class="dcard-footer">
      <div class="dstatus ${d.fromExcel ? 'incompleto' : 'procesando'}" id="ds-${safeId}">${statusLabel(d.fromExcel ? 'incompleto' : 'procesando')}</div>
      <div class="dexp" id="de-${safeId}"></div>
    </div>
    <div class="dcard-usuario">
      <div id="du-${safeId}" class="badge pend">â€”</div>
      <div id="due-${safeId}" class="dexp"></div>
    </div>`;
}

function docRow(type, icon, label, cpf) {
  const id = cpf.replace(/\W/g,'_');
  return `<div class="ddoc doc-clickable" id="ddoc-${type}-${id}" onclick="openDocModal('${cpf}','${type}')">
    <div class="ddoc-icon">${icon}</div>
    <div class="ddoc-name">${label}</div>
    <div class="ddoc-status pending" id="dr-${type}-${id}">â€” Pendiente</div>
  </div>`;
}

function updateCard(cpf) {
  const d = DRIVERS[cpf];
  const id = cpf.replace(/\W/g,'_');

  // Update name
  const dn = document.getElementById('dn-' + id);
  if (dn) dn.textContent = d.name;

  // Update subtitle (CPF or CNH num)
  const subtitleEl = dn && dn.nextElementSibling;
  if (subtitleEl && subtitleEl.classList.contains('dcpf')) {
    subtitleEl.textContent = d.cpf ? d.cpf : (d.cnh_num ? 'CNH ' + d.cnh_num : '');
  }

  // Excel tag
  if (d.fromExcel && d.el) d.el.classList.add('from-excel');

  // Update photo
  if (d.photo) {
    const av = document.getElementById('av-' + id);
    if (av && !av.querySelector('img')) av.innerHTML = `<img src="${d.photo}" alt="">`;
  }

  // Update each doc row
  updateDocRow('cnh', cpf, d.docs.cnh);
  updateDocRow('tox', cpf, d.docs.tox);
  updateDocRow('train', cpf, d.docs.train);

  // Overall status (persona docs status)
  const status = driverStatus(cpf);
  const ds = document.getElementById('ds-' + id);
  if (ds) { ds.className = 'dstatus ' + status; ds.innerHTML = statusLabel(status); }

  // Expiry info
  const de = document.getElementById('de-' + id);
  if (de && d.docs.cnh && d.docs.cnh.validity) de.textContent = 'CNH: ' + d.docs.cnh.validity;

  // Usuario badge
  updateUsuarioBadge(cpf, status);

  // Card border
  if (d.el) d.el.classList.remove('apto-card','inapto-card');

  // Checkbox only enabled when apto
  const chk = document.getElementById('chk-' + id);
  if (chk) chk.classList.toggle('disabled', status !== 'apto');

  applyFilter(d.el, status);
}

function updateUsuarioBadge(cpf, status) {
  const d = DRIVERS[cpf];
  const id = cpf.replace(/\W/g,'_');
  const duEl = document.getElementById('du-' + id);
  const dueEl = document.getElementById('due-' + id);
  if (!duEl) return;

  const usrStatus = userReadyStatus(cpf, status);
  const labels = {
    listo:      { cls: 'ok',   txt: 'âœ“ LISTO' },
    falta_docs: { cls: 'pend', txt: 'â³ Docs pendientes' },
    no_apto:    { cls: 'err',  txt: 'âœ— No apto' },
    falta_email:{ cls: 'warn', txt: 'âš  Sin email' },
    falta_datos:{ cls: 'warn', txt: 'âš  Falta datos' },
    sin_datos:  { cls: 'pend', txt: 'â€” Sin datos Excel' },
  };
  const { cls, txt } = labels[usrStatus] || labels.sin_datos;
  duEl.className = 'badge ' + cls;
  duEl.textContent = txt;
  if (dueEl) dueEl.textContent = d.email ? d.email.split('@')[0] + 'â€¦' : '';
}

function userReadyStatus(cpf, docStatus) {
  const d = DRIVERS[cpf];
  docStatus = docStatus || driverStatus(cpf);
  if (!d.fromExcel && !d.email) return 'sin_datos';
  if (docStatus === 'inapto') return 'no_apto';
  if (docStatus !== 'apto') return 'falta_docs';
  if (!d.email) return 'falta_email';
  if (!d.transportadora) return 'falta_datos';
  return 'listo';
}

function updateDocRow(type, cpf, doc) {
  const id = cpf.replace(/\W/g,'_');
  const el = document.getElementById('dr-' + type + '-' + id);
  if (!el) return;
  if (!doc) { el.className = 'ddoc-status pending'; el.textContent = 'â€” Pendiente'; return; }
  const valid = isDocValid(DRIVERS[cpf], type);
  if (valid === true) {
    el.className = 'ddoc-status ok';
    let detail = 'âœ“ Vigente';
    if (type === 'cnh' && doc.validity) detail = 'âœ“ ' + doc.validity;
    if (type === 'tox' && doc.validity_date) detail = 'âœ“ ' + doc.validity_date;
    if (type === 'train' && doc.completion_date) detail = 'âœ“ ' + doc.completion_date;
    el.textContent = detail;
  } else {
    el.className = 'ddoc-status err';
    let reason = 'âœ— No vÃ¡lido';
    if (type === 'cnh') reason = doc.status === 'EXPIRED' ? 'âœ— Vencida' : 'âœ— No vÃ¡lida';
    if (type === 'tox') reason = doc.result === 'POSITIVE' ? 'âœ— Positivo' : 'âœ— Vencido';
    if (type === 'train') reason = 'âœ— Vencido (>' + CFG.months + 'm)';
    el.textContent = reason;
  }
}

function statusLabel(s) {
  const labels = { apto:'â— APTO PARA ALTA', inapto:'â— NO APTO', incompleto:'â— INCOMPLETO', procesando:'â— PROCESANDOâ€¦' };
  const dot = `<span class="dstatus-dot"></span>`;
  return dot + (s==='apto'?'APTO PARA ALTA':s==='inapto'?'NO APTO':s==='incompleto'?'INCOMPLETO':'PROCESANDOâ€¦');
}

// â”€â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
  const keys = Object.keys(DRIVERS);
  let apto=0, pend=0, personaListo=0, usuarioListo=0;
  keys.forEach(k => {
    const s = driverStatus(k);
    if (s==='apto') { apto++; personaListo++; }
    else pend++;
    if (userReadyStatus(k, s) === 'listo') usuarioListo++;
  });
  document.getElementById('st-total').textContent = keys.length;
  document.getElementById('st-files').textContent = DONE_FILES;
  document.getElementById('st-apto').textContent = apto;
  document.getElementById('st-persona').textContent = personaListo;
  document.getElementById('st-usuario').textContent = usuarioListo;
  document.getElementById('st-pend').textContent = pend;
  updateActionBar();
}

// â”€â”€â”€ FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterCards(f) {
  currentFilter = f;
  ['all','apto','inapto'].forEach(x => document.getElementById('f-'+x).classList.toggle('active', x===f));
  Object.keys(DRIVERS).forEach(cpf => {
    applyFilter(DRIVERS[cpf].el, driverStatus(cpf));
  });
}

function applyFilter(el, status) {
  if (!el) return;
  if (currentFilter === 'all') { el.style.display = ''; return; }
  el.style.display = (status === currentFilter) ? '' : 'none';
}

// â”€â”€â”€ SELECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SELECTED = new Set();

function toggleSelect(cpf) {
  if (driverStatus(cpf) !== 'apto') return;
  const id = cpf.replace(/\W/g,'_');
  const chk = document.getElementById('chk-' + id);
  const card = DRIVERS[cpf].el;
  if (SELECTED.has(cpf)) {
    SELECTED.delete(cpf);
    chk.classList.remove('on');
    card.classList.remove('selected');
  } else {
    SELECTED.add(cpf);
    chk.classList.add('on');
    card.classList.add('selected');
  }
  updateActionBar();
}

function selectAllApto() {
  Object.keys(DRIVERS).forEach(cpf => {
    if (driverStatus(cpf) === 'apto' && !SELECTED.has(cpf)) toggleSelect(cpf);
  });
}

function updateActionBar() {
  const bar = document.getElementById('action-bar');
  const count = SELECTED.size;
  document.getElementById('ab-count').textContent = count + ' chofer' + (count!==1?'es':'');
  bar.classList.toggle('on', count > 0);
}

// â”€â”€â”€ UPLOAD TO VECFLEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function uploadSelected() {
  if (SELECTED.size === 0) return;
  const btn = document.querySelector('.btn-upload');
  btn.disabled = true;
  btn.textContent = 'Cargandoâ€¦';

  const payload = [...SELECTED].map(cpf => {
    const d = DRIVERS[cpf];
    return {
      name: d.name,
      cpf: d.cpf,
      // Persona data
      documents: {
        cnh: d.docs.cnh,
        toxicology: d.docs.tox,
        training: d.docs.train
      },
      status: 'APTO',
      // Usuario data (from Excel or manual)
      usuario: d.es_usuario ? {
        email: d.email,
        transportadora: d.transportadora,
        base: d.base,
        perfil: d.perfil,
        categoria: d.categoria,
        cnh_num: d.cnh_num,
      } : null,
      uploaded_at: new Date().toISOString()
    };
  });

  const endpoint = CFG.endpoint || null;

  if (endpoint) {
    try {
      const resp = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ choferes: payload })
      });
      if (resp.ok) toast(`âœ“ ${payload.length} chofer(es) cargados en VecFleet`);
      else toast('Error al conectar con VecFleet', 'err');
    } catch(e) {
      toast('Error de red: ' + e.message, 'err');
    }
  } else {
    // Mock: download JSON
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify({ choferes: payload }, null, 2)], {type:'application/json'}));
    a.download = 'vecfleet_alta_masiva.json';
    a.click();
    toast(`âœ“ JSON generado con ${payload.length} chofer(es)`);
  }

  btn.disabled = false;
  btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:6px"><path d="M12 2a4 4 0 0 1 4 4c0 1.5-.8 2.8-2 3.5V11h2a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h-2v1.5c1.2.7 2 2 2 3.5a4 4 0 0 1-8 0c0-1.5.8-2.8 2-3.5V16H8a2 2 0 0 1-2-2v-1a2 2 0 0 1 2-2h2V9.5C8.8 8.8 8 7.5 8 6a4 4 0 0 1 4-4z"/></svg>Cargar con Eric`;
}

// â”€â”€â”€ OCR VERIFICATION MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DOC_META = {
  cnh:   { label: 'ğŸªª CNH / Licencia de Conducir', fields: [
    { key: 'name',         lbl: 'Nombre' },
    { key: 'cpf',          lbl: 'CPF' },
    { key: 'registro',     lbl: 'NÂº Registro' },
    { key: 'dob',          lbl: 'Fecha nacimiento' },
    { key: 'validity',     lbl: 'Vencimiento',  style: d => d.status === 'VALID' ? 'ok' : 'err' },
    { key: 'category',     lbl: 'CategorÃ­a' },
    { key: 'issuer_state', lbl: 'Estado emisor' },
    { key: 'status',       lbl: 'Estado doc',   style: d => d.status === 'VALID' ? 'ok' : 'err',
      fmt: v => v === 'VALID' ? 'âœ“ VIGENTE' : 'âœ— VENCIDA' },
  ]},
  tox:   { label: 'ğŸ”¬ Laudo ToxicolÃ³gico', fields: [
    { key: 'name',            lbl: 'Nombre' },
    { key: 'cpf',             lbl: 'CPF' },
    { key: 'lab',             lbl: 'Laboratorio' },
    { key: 'collection_date', lbl: 'Fecha colecciÃ³n' },
    { key: 'validity_date',   lbl: 'Vencimiento', style: d => d.is_valid ? 'ok' : 'warn' },
    { key: 'result',          lbl: 'Resultado',   style: d => d.result === 'NEGATIVE' ? 'ok' : 'err',
      fmt: v => v === 'NEGATIVE' ? 'âœ“ NEGATIVO' : 'âœ— POSITIVO' },
    { key: 'is_valid',        lbl: 'VÃ¡lido',       style: d => d.is_valid ? 'ok' : 'err',
      fmt: v => v ? 'âœ“ SÃ­' : 'âœ— No' },
  ]},
  train: { label: 'ğŸ“ Certificado de Entrenamiento', fields: [
    { key: 'name',            lbl: 'Nombre' },
    { key: 'cpf',             lbl: 'CPF' },
    { key: 'institution',     lbl: 'InstituciÃ³n' },
    { key: 'course',          lbl: 'Curso' },
    { key: 'completion_date', lbl: 'Fecha realizaciÃ³n' },
  ]},
};

function openDocModal(cpf, type) {
  const d = DRIVERS[cpf];
  if (!d) return;
  const doc = d.docs[type];
  const meta = DOC_META[type];
  if (!meta) return;

  document.getElementById('ocr-title').textContent = meta.label;
  document.getElementById('ocr-sub').textContent = d.name + (d.cpf ? '  Â·  CPF ' + d.cpf : '');

  // Image
  const img = document.getElementById('ocr-img');
  const imgSide = img.parentElement;
  if (doc && doc._preview) {
    img.src = doc._preview;
    img.style.display = '';
    imgSide.querySelector('.ocr-no-doc')?.remove();
  } else {
    img.style.display = 'none';
    if (!imgSide.querySelector('.ocr-no-doc')) {
      const nd = document.createElement('div');
      nd.className = 'ocr-no-doc';
      nd.innerHTML = '<span style="font-size:2rem">ğŸ“„</span><span>Documento no procesado aÃºn</span>';
      imgSide.appendChild(nd);
    }
  }

  // Fields
  const fieldsEl = document.getElementById('ocr-fields');
  if (!doc) {
    fieldsEl.innerHTML = '<div class="ocr-no-doc" style="height:auto;padding:2rem 0">Sin datos extraÃ­dos â€” subÃ­ el documento PDF/imagen</div>';
  } else {
    fieldsEl.innerHTML = meta.fields.map(f => {
      let val = doc[f.key];
      const display = val === null || val === undefined || val === '' ? '<span class="ocr-field-val dim">â€”</span>'
        : `<span class="ocr-field-val ${f.style ? f.style(doc) : ''}">${f.fmt ? f.fmt(val) : val}</span>`;
      return `<div class="ocr-field"><span class="ocr-field-lbl">${f.lbl}</span>${display}</div>`;
    }).join('');
  }

  document.getElementById('ocr-modal').classList.add('on');
  document.body.style.overflow = 'hidden';
  // Re-apply transform AFTER modal layout is computed (fixes black image bug â€”
  // the load event can fire before the modal is visible, giving wrap.clientWidth=0 â†’ scale=0)
  requestAnimationFrame(() => requestAnimationFrame(() => { _z=1;_tx=0;_ty=0; _applyTransform(); }));
}

function closeOcrModal(e) {
  if (e && e.target !== document.getElementById('ocr-modal')) return;
  document.getElementById('ocr-modal').classList.remove('on');
  document.body.style.overflow = '';
  resetZoom();
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeOcrModal(null); });

// â”€â”€â”€ ZOOM / PAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _z = 1, _tx = 0, _ty = 0;   // zoom scale, translate x/y
let _dragging = false, _dx = 0, _dy = 0;

function _applyTransform() {
  const img = document.getElementById('ocr-img');
  if (!img) return;
  // Center the image in its container, then apply scale + pan offset
  const wrap = document.getElementById('ocr-zoom-wrap');
  const ww = wrap.clientWidth, wh = wrap.clientHeight;
  const iw = img.naturalWidth || img.clientWidth;
  const ih = img.naturalHeight || img.clientHeight;
  // Fit-to-container base scale
  const baseScale = Math.min(ww / iw, wh / ih, 1);
  const scale = baseScale * _z;
  const cx = (ww - iw * scale) / 2;
  const cy = (wh - ih * scale) / 2;
  img.style.transform = `translate(${cx + _tx}px, ${cy + _ty}px) scale(${scale})`;
  document.getElementById('ocr-zoom-pct').textContent = Math.round(_z * 100) + '%';
}

function zoomDoc(delta) {
  _z = Math.min(Math.max(_z + delta, 0.5), 6);
  _applyTransform();
}

function resetZoom() {
  _z = 1; _tx = 0; _ty = 0;
  _applyTransform();
}

// Mouse wheel zoom
document.getElementById('ocr-zoom-wrap').addEventListener('wheel', e => {
  e.preventDefault();
  const delta = e.deltaY < 0 ? 0.15 : -0.15;
  _z = Math.min(Math.max(_z + delta, 0.5), 6);
  _applyTransform();
}, { passive: false });

// Double-click to reset
document.getElementById('ocr-zoom-wrap').addEventListener('dblclick', () => resetZoom());

// Drag to pan
document.getElementById('ocr-zoom-wrap').addEventListener('mousedown', e => {
  if (_z <= 1) return;
  _dragging = true; _dx = e.clientX - _tx; _dy = e.clientY - _ty;
  document.getElementById('ocr-zoom-wrap').classList.add('grabbing');
});
document.addEventListener('mousemove', e => {
  if (!_dragging) return;
  _tx = e.clientX - _dx; _ty = e.clientY - _dy;
  _applyTransform();
});
document.addEventListener('mouseup', () => {
  _dragging = false;
  document.getElementById('ocr-zoom-wrap')?.classList.remove('grabbing');
});

// Touch pinch-to-zoom + drag
let _lastTouchDist = null, _lastTouchMid = null;
document.getElementById('ocr-zoom-wrap').addEventListener('touchstart', e => {
  if (e.touches.length === 2) {
    const [a, b] = e.touches;
    _lastTouchDist = Math.hypot(b.clientX - a.clientX, b.clientY - a.clientY);
    _lastTouchMid = { x: (a.clientX + b.clientX) / 2, y: (a.clientY + b.clientY) / 2 };
  } else if (e.touches.length === 1 && _z > 1) {
    _dragging = true; _dx = e.touches[0].clientX - _tx; _dy = e.touches[0].clientY - _ty;
  }
}, { passive: true });
document.getElementById('ocr-zoom-wrap').addEventListener('touchmove', e => {
  e.preventDefault();
  if (e.touches.length === 2 && _lastTouchDist) {
    const [a, b] = e.touches;
    const dist = Math.hypot(b.clientX - a.clientX, b.clientY - a.clientY);
    _z = Math.min(Math.max(_z * (dist / _lastTouchDist), 0.5), 6);
    _lastTouchDist = dist;
    _applyTransform();
  } else if (e.touches.length === 1 && _dragging) {
    _tx = e.touches[0].clientX - _dx; _ty = e.touches[0].clientY - _dy;
    _applyTransform();
  }
}, { passive: false });
document.getElementById('ocr-zoom-wrap').addEventListener('touchend', () => {
  _lastTouchDist = null; _dragging = false;
});

// Re-apply transform on image load (natural dimensions may change)
document.getElementById('ocr-img').addEventListener('load', () => { _z=1;_tx=0;_ty=0; _applyTransform(); });

// â”€â”€â”€ VIEW TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleView(mode) {
  VIEW_MODE = mode;
  const grid = document.getElementById('driver-grid');
  grid.classList.toggle('list-view', mode === 'list');
  document.getElementById('v-card').classList.toggle('active', mode === 'card');
  document.getElementById('v-list').classList.toggle('active', mode === 'list');
}

// PDF.js worker
if (window['pdfjs-dist/build/pdf']) {
  window['pdfjs-dist/build/pdf'].GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}
</script>
</body>
</html>
